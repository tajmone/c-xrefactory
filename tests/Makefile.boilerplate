# Boilerplate Makefile for many c-xref tests
#
# - Names the test from directory name
# - Generates a specific, simple, c-xrefrc from a template
#
# In the test Makefiles you just need to include this and define the
# $(TEST) target where the execution of the test should go.
#

# OK and FAIL messages (with colour)
OK = echo "Tests in '$(TEST)': $(shell tput setaf 2)Ok$(shell tput sgr0)"
FAIL = echo "Tests in '$(TEST)': $(shell tput setaf 1)Failed$(shell tput sgr0)"

TEST = $(shell basename '$(CURDIR)')

all: .c-xrefrc $(TEST)

# All tests that uses a server driver should use this
EDIT_SERVER_DRIVER = ../../utils/server_driver.py

# Since absolute paths are abundant we need to...
NORMALIZE = sed -e "s+$(CURDIR)+CURDIR+g" -e "s/ len=[0-9]*/ len=<n>/g"

# Verification is often done by comparing an output with the expected
VERIFY = cmp output expected ; \
	if [ $$? -ne 0 ] ; then \
		$(FAIL) ; \
		diff output expected ; \
		exit 1 ; \
	else \
		$(OK) ; \
		exit 0 ; \
	fi

# If the test requires a .c-xrefrc for test directory you need to
# generate one. The .c-xrefrc requires absolute paths, and to work in
# any directory, a .c-xrefrc can be generated from a common
# c-xrefrc.tpl by replacing some symbols as per rules below.
#
# We use the name '.c-xrefrc' so that a test can set HOME to CWD and
# editors will automatically read the correct file as if it was in the
# users HOME.
#
# TODO: we should check for a c-xrefrc.tpl in the test directory and
# use that instead, currently they have to do this in the Makefile if
# the standard does not work
.c-xrefrc: ../c-xrefrc.tpl
	@sed -e "s+CURDIR+$(CURDIR)+g" -e "s+TEST+$(TEST)+g" ../c-xrefrc.tpl > .c-xrefrc

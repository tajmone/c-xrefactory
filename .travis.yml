language: c
os:
  - linux
  - osx

dist: focal
osx_image: xcode12

if: NOT tag = stable

addons:
  apt:
    packages:
    - lcov

before_install:
    - if: "$TRAVIS_OS_NAME" = "linux"
    - wget https://github.com/cgreen-devs/cgreen/releases/download/1.4.0/cgreen_1.4.0_amd64.deb
    - sudo apt-get install ./cgreen_1.4.0_amd64.deb
    - sudo apt install openjdk-8-jre
    - lcov --version
    - gcov --version
    - gem install coveralls-lcov

script:
    - cd src
    # Separate coverage for unittest to Codecov
    - cd unittests
    - make COVERAGE=--coverage
    - if [ "$TRAVIS_OS_NAME" = "linux" ]; then bash <(curl -s https://codecov.io/bash) -X gcovout ; fi
    - cd ..
    # Now reset coverage and run everything
    - if [ "$TRAVIS_OS_NAME" = "linux" ]; then lcov -q -z -d . ; fi
    - make GCOV_OPTIONS= ci                   # = unit, build & test (even slow)
    - cd ..

branches:
    except:
        - stable

after_success:
    - if: "$TRAVIS_OS_NAME" = "linux"
    # Coverage for tests to Coveralls, but only for linux
    - lcov -q -d . -c -o coverage.info
    - lcov -q --remove coverage.info '*.mock' '*.tab.c' '/usr/*' -o coverage.info
    - coveralls-lcov coverage.info
    # Move "stable" tag if on master
    - ./.travis.merge_to_stable_maybe.sh
